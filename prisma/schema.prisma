generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



enum AdminUserAppRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  VIEW_ONLY
}




enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}


enum AdminUserStatus{
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum EntityRegistrationStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}


enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  PENDING_CLIENT_INPUT
}
enum TaskPriority {
 LOW
MEDIUM
HIGH
}



enum FrequencyUnit {
  DAY
  MONTH
  YEAR
}


enum TASK_SOURCE {
  CRON_SYSTEM_GEN
  MANUALLY
  IMPORT
}






enum EntityGroupType {
  FAMILY
  BUSINESS
  TRUST
  PARTNERSHIP
  ORGANIZATION
  NON_PROFIT
  COOPERATIVE
  ASSOCIATION
  JOINT_VENTURE
  GOVERNMENT
  OTHER
}

enum EntityGroupRole {
  OWNER
  CO_OWNER
  BENEFICIARY
  MEMBER
  MANAGING_MEMBER
  DIRECTOR
  EXECUTIVE_DIRECTOR
  NOMINEE_DIRECTOR
  PARTNER
  MANAGING_PARTNER
  TRUSTEE
  SETTLOR
  SHAREHOLDER
  AUTHORIZED_SIGNATORY
  REPRESENTATIVE
  EMPLOYEE
  ADVISOR
  OBSERVER
  OTHER
}





enum IndianState {
  ANDHRA_PRADESH
  ARUNACHAL_PRADESH
  ASSAM
  BIHAR
  CHHATTISGARH
  GOA
  GUJARAT
  HARYANA
  HIMACHAL_PRADESH
  JHARKHAND
  KARNATAKA
  KERALA
  MADHYA_PRADESH
  MAHARASHTRA
  MANIPUR
  MEGHALAYA
  MIZORAM
  NAGALAND
  ODISHA
  PUNJAB
  RAJASTHAN
  SIKKIM
  TAMIL_NADU
  TELANGANA
  TRIPURA
  UTTAR_PRADESH
  UTTARAKHAND
  WEST_BENGAL
  ANDAMAN_AND_NICOBAR_ISLANDS
  CHANDIGARH
  DADRA_AND_NAGAR_HAVELI_AND_DAMAN_AND_DIU
  DELHI
  JAMMU_AND_KASHMIR
  LADAKH
  LAKSHADWEEP
  PUDUCHERRY
}

enum EntityType {
  INDIVIDUAL
  UNREGISTERED_INDIVIDUAL
  PRIVATE_LIMITED_COMPANY
  PUBLIC_LIMITED_COMPANY
  ONE_PERSON_COMPANY
  SECTION_8_COMPANY
  PRODUCER_COMPANY
  SOLE_PROPRIETORSHIP
  PARTNERSHIP_FIRM
  LIMITED_LIABILITY_PARTNERSHIP
  TRUST
  SOCIETY
  COOPERATIVE_SOCIETY
  FOREIGN_COMPANY
  GOVERNMENT_COMPANY
}




model Entity {
  id              String       @id @default(uuid()) @db.Uuid

  entity_type     EntityType
  name            String       @db.Char(120)

  pan             String?       @unique @db.Char(10)
  tan             String?      @db.Char(10)

  email           String
  primary_phone   String
  
  contact_person  String?    @db.Char(100)
  secondary_phone String?

  address_line1   String?      @db.Char(200)
  address_line2   String?      @db.Char(200)
  city            String?       @db.Char(50)
  state           String?       @db.Char(50)
  pincode         String?      @db.Char(6)

  is_retainer     Boolean      @default(false)
  status          EntityStatus @default(INACTIVE)

  created_by      String       @db.Uuid
  updated_by      String?      @db.Uuid
  deleted_by      String?      @db.Uuid

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  deleted_at      DateTime?

  creator         AdminUser    @relation("entity_creator", fields: [created_by], references: [id])
  updater         AdminUser?   @relation("entity_updater", fields: [updated_by], references: [id])
  deleter         AdminUser?   @relation("entity_deleter", fields: [deleted_by], references: [id])

  registrations   EntityRegistration[]
  tasks           Task[]
  group_members   EntityGroupMember[]


  @@index([name])
  @@index([pan])
  @@index([email])
  @@index([status])
  @@index([created_at])
  @@index([deleted_at])
  @@index([is_retainer, status])
  @@index([status, is_retainer, created_at])
}



model EntityGroup {
  id         String          @id @default(uuid()) @db.Uuid
  name       String
  group_type EntityGroupType
  created_at DateTime        @default(now())

  members EntityGroupMember[]

  @@index([group_type])
  @@index([created_at])
}



model EntityGroupMember {
  id              String          @id @default(uuid()) @db.Uuid
  entity_group_id String          @db.Uuid
  entity_id       String          @db.Uuid
  role            EntityGroupRole

  group  EntityGroup @relation(fields: [entity_group_id], references: [id], onDelete: Cascade)
  entity Entity      @relation(fields: [entity_id], references: [id], onDelete: Cascade)

  @@unique([entity_group_id, entity_id])
  @@index([entity_group_id])
  @@index([entity_id])
  @@index([role])
}



model EntityRegistration {
  id                   String                       @id @default(uuid()) @db.Uuid
  entity_id            String                       @db.Uuid
  registration_type_id String                       @db.Uuid
  registration_number  String
  state                IndianState

  effective_from       DateTime?
  effective_to         DateTime?
  status               EntityRegistrationStatus     @default(INACTIVE)
  is_primary           Boolean                      @default(false)

  created_by           String                   @db.Uuid
  updated_by           String?                  @db.Uuid
  deleted_by           String?                  @db.Uuid
  deleted_at           DateTime?

  created_at           DateTime                     @default(now())
  updated_at           DateTime                     @updatedAt


  entity           Entity                      @relation(fields: [entity_id], references: [id], onDelete: Cascade)
  registrationType RegistrationType            @relation(fields: [registration_type_id], references: [id])

  creator              AdminUser          @relation("er_creator", fields: [created_by], references: [id])
  updater              AdminUser?         @relation("er_updater", fields: [updated_by], references: [id])
  deleter              AdminUser?         @relation("er_deleter", fields: [deleted_by], references: [id])


  @@unique([entity_id, registration_type_id, registration_number])
  @@index([status])
  @@index([deleted_at])
  @@index([entity_id])
  @@index([registration_type_id])
  @@index([is_primary])
  @@index([effective_from, effective_to])
  @@index([entity_id, status])
  @@index([registration_type_id, status])
  @@index([entity_id, status, effective_to])
}



model RegistrationType {
  id                String   @id @default(uuid()) @db.Uuid
  code              String   @unique @db.VarChar(50)
  name              String?
  description       String?
  is_active         Boolean  @default(false)

  validation_regex  String?
  validation_hint   String?

  created_at        DateTime @default(now())

  registrations     EntityRegistration[]
  compliance_rules  ComplianceRule[]

  @@index([is_active])
  @@index([code])
}



model ComplianceRule {
  id                   String        @id @default(uuid()) @db.Uuid
  compliance_code      String        @unique
  name                 String

  registration_type_id String        @db.Uuid
  registrationType     RegistrationType @relation(fields: [registration_type_id], references: [id])



  // MONTHLY | QUARTERLY | HALFYEARLY | YEARLY
  frequency_type       String         

  // months in which cron should trigger this rule
  // e.g. [1,2,3...12] or [3,6,9,12] or [3]
  anchor_months        Json           

  // MONTH | QUARTER | HALFYEAR | YEAR  (for naming/period label)
  period_label_type    String         

  // due date mechanics
  due_day              Int            // 1â€“31
  due_month_offset     Int            // -1,0,+1,+4 etc
  grace_days           Int            @default(0)

  is_active            Boolean        @default(true)

  // --------- EXISTING AUDIT FIELDS STAY ---------
  created_by           String         @db.Uuid
  updated_by           String?        @db.Uuid
  created_at           DateTime       @default(now())
  updated_at           DateTime       @updatedAt

  creator              AdminUser      @relation("cr_creator", fields: [created_by], references: [id])
  updater              AdminUser?     @relation("cr_updater", fields: [updated_by], references: [id])

  task_templates       TaskTemplate[]

  @@index([registration_type_id])
  @@index([is_active])
  @@index([compliance_code])
  @@index([registration_type_id, is_active])
}



model AdminUser { 
  id       String @id @default(uuid()) @db.Uuid 
  name     String 
  email    String @unique 
  password String? 
  

  user_code        String    @unique 
  status           AdminUserStatus @default(INACTIVE)
  date_of_joining  DateTime  @default(now())
  onboarding_completed     Boolean   @default(false)
  admin_role  AdminUserAppRole @default(EMPLOYEE)

  phone            String    @unique 
  alternate_phone  String?  
  last_invite_sent_at      DateTime?

  address_line1   String?      @db.Char(200)
  address_line2   String?      @db.Char(200)
  city            String?       @db.Char(50)
  state           IndianState?       
  pincode         String?      @db.Char(6)


  totp_secret              String?
  last_login_at            DateTime?
  password_set_at          DateTime?
  last_password_reset_request_at          DateTime?
  two_fa_verified_at DateTime? 
  

  departments          AdminUserDepartment[] 
  created_tasks        Task[]                  @relation("task_creator") 
  task_assignments     TaskAssignment[]        @relation("assignee") 
  assigned_tasks       TaskAssignment[]        @relation("assigner") 
  created_task_modules TaskModule[]            @relation("creator") 
  updated_task_modules TaskModule[]            @relation("updater") 
  deleted_task_modules TaskModule[]            @relation("deleter") 
  created_templates    TaskTemplate[] 
  auth_provider   String   @default("credentials")  
  provider_id     String?  
  created_modules      BillableModule[]        @relation("module_creator") 
  updated_modules      BillableModule[]        @relation("module_updater") 


 
  created_by String?  @db.Uuid 
  updated_by String?  @db.Uuid 
  deleted_by String?  @db.Uuid 
  deleted_at DateTime? 
 
  creator    AdminUser? @relation("admin_creator", fields: [created_by], references: [id]) 
  updater    AdminUser? @relation("admin_updater", fields: [updated_by], references: [id]) 
  deleter    AdminUser? @relation("admin_deleter", fields: [deleted_by], references: [id]) 
 
  // Add these opposite relation fields: 
  created_admins       AdminUser[]             @relation("admin_creator") 
  updated_admins       AdminUser[]             @relation("admin_updater") 
  deleted_admins       AdminUser[]             @relation("admin_deleter") 
   
  created_entities     Entity[]                @relation("entity_creator") 
  updated_entities     Entity[]                @relation("entity_updater") 
  deleted_entities     Entity[]                @relation("entity_deleter") 
   
  created_registrations EntityRegistration[]   @relation("er_creator") 
  updated_registrations EntityRegistration[]   @relation("er_updater") 
  deleted_registrations EntityRegistration[]   @relation("er_deleter") 
   

   
  created_rules        ComplianceRule[]        @relation("cr_creator") 
  updated_rules        ComplianceRule[]        @relation("cr_updater") 
   
  last_activity_tasks  Task[]                  @relation 
  updated_tasks        Task[]                  @relation("task_updator") 
   

 
  @@index([email]) 
  @@index([name])
  @@index([user_code])
  @@index([phone])
  @@index([status])
}


model AdminUserCounter {
  id            String   @id @default(uuid()) @db.Uuid
  current_count Int      @default(0)
  updated_at    DateTime @updatedAt
  
  @@map("admin_user_counter")
}


model Department {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique

  users AdminUserDepartment[]
}

model AdminUserPermission {
  admin_user_id String @db.Uuid
  permission_id String @db.Uuid

  adminUser  AdminUser  @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  assigned_at DateTime @default(now())

  @@id([admin_user_id, permission_id])
  @@index([admin_user_id])
  @@index([permission_id])
}






model AdminUserDepartment {
  admin_user_id String @db.Uuid
  department_id String @db.Uuid

  adminUser  AdminUser  @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)
  department Department @relation(fields: [department_id], references: [id], onDelete: Cascade)

  @@id([admin_user_id, department_id])
  @@index([admin_user_id])
  @@index([department_id])
}


model Permission {
  id   String @id @default(uuid()) @db.Uuid
  code String @unique
}







model TaskCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(50)
  description String?
  is_active   Boolean  @default(true)

  created_at  DateTime @default(now())

  tasks       Task[]
}


model Task {
  id                 String        @id @default(uuid()) @db.Uuid
  entity_id          String        @db.Uuid
  created_by         String        @db.Uuid
  updated_by         String        @db.Uuid
  title              String
  description        String?
  status             TaskStatus    @default(PENDING)
  start_date         DateTime?
  end_date           DateTime?
  due_date           DateTime?
  priority           TaskPriority    @default(NORMAL)
  entity_registration_id   String?
  registration EntityRegistration? @relation(fields: [entity_registration_id], references: [id])
  task_source  TASK_SOURCE

  is_assigned_to_all Boolean       @default(false)
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt
  period_start   DateTime?
  period_end     DateTime?
  financial_year String?
  period_label   String?

  has_activity       Boolean   @default(false)
  last_activity_at   DateTime?
  last_activity_by   String?   @db.Uuid
  task_category_id String? @db.Uuid
  compliance_rule_id String?       @db.Uuid

  lastActor          AdminUser? @relation(fields: [last_activity_by],references: [id])
  entity        Entity           @relation(fields: [entity_id], references: [id], onDelete: Cascade)
  creator       AdminUser        @relation("task_creator", fields: [created_by], references: [id])
  updator       AdminUser        @relation("task_updator", fields: [updated_by], references: [id])
  category      TaskCategory?    @relation(fields: [task_category_id], references: [id])
  assignments   TaskAssignment[]
  task_modules  TaskModule[]


  @@index([status])
  @@index([entity_id])
  @@index([created_by])
  @@index([due_date])
  @@index([created_at])
  @@index([priority])
  @@index([compliance_rule_id])
  @@index([entity_id, status])
  @@index([entity_id, status, due_date])
  @@index([status, due_date])
  @@index([compliance_rule_id, status])
  @@unique([entity_id, entity_registration_id, compliance_rule_id, period_start, period_end])
}



model TaskAssignment {
  id                String   @id @default(uuid()) @db.Uuid
  task_id           String   @db.Uuid
  admin_user_id     String   @db.Uuid
  assigned_by       String   @db.Uuid
  assignment_source String?
  assigned_at       DateTime @default(now())

  task     Task      @relation(fields: [task_id], references: [id], onDelete: Cascade)
  assignee AdminUser @relation("assignee", fields: [admin_user_id], references: [id])
  assigner AdminUser @relation("assigner", fields: [assigned_by], references: [id])

  @@index([task_id])
  @@index([admin_user_id])
  @@index([assigned_by])
  @@index([assigned_at])
  @@index([admin_user_id, task_id])
}


model TaskTemplate {
  id                   String   @id @default(uuid()) @db.Uuid
  compliance_rule_id   String   @db.Uuid
  created_by           String   @db.Uuid
  title_template       String   @db.VarChar(180)
  description_template String?
  is_active            Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  complianceRule ComplianceRule       @relation(fields: [compliance_rule_id], references: [id])
  creator        AdminUser            @relation(fields: [created_by], references: [id])
  modules        TaskTemplateModule[]

  @@unique([compliance_rule_id, title_template])
  @@index([compliance_rule_id])
  @@index([created_by])
  @@index([is_active])
  @@index([compliance_rule_id, is_active])
}



model TaskTemplateModule {
  id                 String   @id @default(uuid()) @db.Uuid
  task_template_id   String   @db.Uuid
  billable_module_id String   @db.Uuid
  is_optional        Boolean  @default(false)
  created_at         DateTime @default(now())

  taskTemplate   TaskTemplate   @relation(fields: [task_template_id], references: [id], onDelete: Cascade)
  billableModule BillableModule @relation(fields: [billable_module_id], references: [id])

  @@unique([task_template_id, billable_module_id])
  @@index([task_template_id])
  @@index([billable_module_id])
}



model BillableModuleCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(50)
  description String?
  is_active   Boolean  @default(true)

  modules     BillableModule[]
}


model BillableModule {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  description   String?
  category_id   String? @db.Uuid
  is_active     Boolean  @default(true)
  is_deleted    Boolean  @default(false)
  created_by    String   @db.Uuid
  updated_by    String?  @db.Uuid
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  creator          AdminUser            @relation("module_creator", fields: [created_by], references: [id])
  updater          AdminUser?           @relation("module_updater", fields: [updated_by], references: [id])
  category BillableModuleCategory?      @relation(fields: [category_id], references: [id])

  template_modules TaskTemplateModule[]
  task_modules     TaskModule[]


  @@index([category_id])
  @@index([category_id, is_active])
  @@index([is_active])
  @@index([is_deleted])
  @@index([created_by])
  @@index([is_active, is_deleted])
}


model TaskModule {
  id                 String   @id @default(uuid()) @db.Uuid
  task_id            String   @db.Uuid
  billable_module_id String   @db.Uuid
  name               String
  remark             String?
  created_by         String   @db.Uuid
  updated_by         String?  @db.Uuid
  deleted_by         String?  @db.Uuid
  is_deleted         Boolean  @default(false)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  task           Task           @relation(fields: [task_id], references: [id], onDelete: Cascade)
  billableModule BillableModule @relation(fields: [billable_module_id], references: [id])
  creator        AdminUser      @relation("creator", fields: [created_by], references: [id])
  updater        AdminUser?     @relation("updater", fields: [updated_by], references: [id])
  deleter        AdminUser?     @relation("deleter", fields: [deleted_by], references: [id])


  @@index([task_id])
  @@index([billable_module_id])
  @@index([is_deleted])
  @@index([created_by])
  @@index([task_id, is_deleted])
  @@index([billable_module_id, is_deleted])
}


  





model Expense {
  id              String   @id @default(uuid()) @db.Uuid

  task_id         String   @db.Uuid
  description     String
  amount          Decimal
  expense_date    DateTime

  expense_bearer  ExpenseBearer   @default(CLIENT)   // from your enum
  is_recoverable  Boolean         @default(true)

  government_reference  String?   // challan no / SRN / ARN
  attachment_url        String?   // proof / challan pdf

  // billing + recovery lifecycle
  is_invoiced     Boolean         @default(false)
  invoiced_at     DateTime?
  invoice_line_id String?         @db.Uuid

  is_reimbursed   Boolean         @default(false)
  reimbursed_at   DateTime?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  task        Task        @relation(fields: [task_id], references: [id], onDelete: Cascade)
  invoiceLine InvoiceLine? @relation(fields: [invoice_line_id], references: [id])

  @@index([task_id])
  @@index([is_recoverable])
  @@index([is_invoiced])
  @@index([invoice_line_id])
}
