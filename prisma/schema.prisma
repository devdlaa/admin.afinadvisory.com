generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Entity {
  id              String                 @id @default(uuid()) @db.Uuid
  entity_type     EntityType
  name            String                 @db.VarChar(120)
  pan             String?                @unique
  email           String
  primary_phone   String
  secondary_phone String?
  address_line1   String?                @db.VarChar(200)
  address_line2   String?                @db.VarChar(200)
  city            String?                @db.VarChar(50)
  state           String?                @db.VarChar(50)
  pincode         String?                @db.Char(6)
  status          EntityStatus           @default(INACTIVE)
  created_at      DateTime               @default(now())
  updated_at      DateTime               @updatedAt
  created_by      String                 @db.Uuid
  deleted_at      DateTime?
  deleted_by      String?                @db.Uuid
  updated_by      String?                @db.Uuid
  contact_person  String?                @db.VarChar(100)
  creator         AdminUser              @relation("entity_creator", fields: [created_by], references: [id])
  deleter         AdminUser?             @relation("entity_deleter", fields: [deleted_by], references: [id])
  updater         AdminUser?             @relation("entity_updater", fields: [updated_by], references: [id])
  custom_fields   EntityCustomField[]
  invoices        Invoice[]
  tasks           Task[]
  reconcile_stats ReconcileStatsCurrent? @relation("ReconcileStats")

  @@index([name])
  @@index([pan])
  @@index([email])
  @@index([status])
  @@index([created_at])
  @@index([deleted_at])
  @@index([status, created_at])
}

model EntityCustomField {
  id         String   @id @default(uuid()) @db.Uuid
  entity_id  String   @db.Uuid
  name       String   @db.VarChar(50)
  value      String?  @db.VarChar(255)
  created_at DateTime @default(now())
  entity     Entity   @relation(fields: [entity_id], references: [id], onDelete: Cascade)

  @@unique([entity_id, name])
  @@index([entity_id])
}

model AdminUser {
  id                                String                @id @default(uuid()) @db.Uuid
  name                              String
  email                             String                @unique
  password                          String?
  auth_provider                     String                @default("credentials")
  created_by                        String?               @db.Uuid
  deleted_at                        DateTime?
  deleted_by                        String?               @db.Uuid
  provider_id                       String?
  updated_by                        String?               @db.Uuid
  address_line1                     String?               @db.VarChar(200)
  address_line2                     String?               @db.VarChar(200)
  alternate_phone                   String?
  city                              String?               @db.VarChar(50)
  date_of_joining                   DateTime              @default(now())
  phone                             String                @unique
  pincode                           String?               @db.Char(6)
  state                             IndianState?
  status                            AdminUserStatus       @default(INACTIVE)
  two_fa_verified_at                DateTime?
  user_code                         String                @unique
  admin_role                        AdminUserAppRole      @default(EMPLOYEE)
  last_invite_sent_at               DateTime?
  last_login_at                     DateTime?
  last_password_reset_request_at    DateTime?
  onboarding_completed              Boolean               @default(false)
  password_set_at                   DateTime?
  totp_secret                       String?
  onboarding_token_hash             String?
  is_2fa_enabled                    Boolean               @default(false)
  onboarding_token_expires_at       DateTime?
  password_reset_token_expires_at   DateTime?
  password_reset_token_hash         String?
  last_onboarding_reset_request_at  DateTime?
  onboarding_reset_token_expires_at DateTime?
  onboarding_reset_token_hash       String?
  creator                           AdminUser?            @relation("admin_creator", fields: [created_by], references: [id])
  created_admins                    AdminUser[]           @relation("admin_creator")
  deleter                           AdminUser?            @relation("admin_deleter", fields: [deleted_by], references: [id])
  deleted_admins                    AdminUser[]           @relation("admin_deleter")
  updater                           AdminUser?            @relation("admin_updater", fields: [updated_by], references: [id])
  updated_admins                    AdminUser[]           @relation("admin_updater")
  permissions                       AdminUserPermission[]
  created_documents                 Document[]            @relation("document_creator")
  created_entities                  Entity[]              @relation("entity_creator")
  deleted_entities                  Entity[]              @relation("entity_deleter")
  updated_entities                  Entity[]              @relation("entity_updater")
  created_invoices                  Invoice[]
  created_tasks                     Task[]                @relation("task_creator")
  last_activity_tasks               Task[]                @relation("last_activity_admin")
  updated_tasks                     Task[]                @relation("task_updater")
  task_assignments                  TaskAssignment[]      @relation("assignee")
  assigned_tasks                    TaskAssignment[]      @relation("assigner")
  created_task_charges              TaskCharge[]          @relation("task_charge_creator")
  deleted_task_charges              TaskCharge[]          @relation("task_charge_deleter")
  restore_task_charges              TaskCharge[]          @relation("task_charge_restorer")
  updated_task_charges              TaskCharge[]          @relation("task_charge_updater")
  created_task_checklist_items      TaskChecklistItem[]   @relation("task_checklist_creator")
  deleted_task_checklist_items      TaskChecklistItem[]   @relation("task_checklist_deleter")
  updated_task_checklist_items      TaskChecklistItem[]   @relation("task_checklist_updater")
  pushTokens                        UserPushToken[]

  @@index([email])
  @@index([name])
  @@index([user_code])
  @@index([phone])
  @@index([status])
}

model AdminUserPermission {
  admin_user_id String     @db.Uuid
  permission_id String     @db.Uuid
  assigned_at   DateTime   @default(now())
  adminUser     AdminUser  @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)
  permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([admin_user_id, permission_id])
  @@index([admin_user_id])
  @@index([permission_id])
}

model Permission {
  id                   String                @id @default(uuid()) @db.Uuid
  code                 String                @unique
  category             String?
  label                String?
  adminUserPermissions AdminUserPermission[]
}

model AdminUserCounter {
  id            String   @id
  current_count Int      @default(0)
  updated_at    DateTime @updatedAt

  @@map("admin_user_counter")
}

model TaskCharge {
  id          String       @id @default(uuid()) @db.Uuid
  task_id     String       @db.Uuid
  title       String
  amount      Decimal      @db.Decimal(12, 2)
  charge_type ChargeType
  
  bearer      ChargeBearer
  status      ChargeStatus
  remark      String?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  created_by  String       @db.Uuid
  deleted_at  DateTime?
  deleted_by  String?      @db.Uuid
  updated_by  String       @db.Uuid
  restored_by String?      @db.Uuid
  entity_id   String?      @db.Uuid
  creator     AdminUser    @relation("task_charge_creator", fields: [created_by], references: [id])
  deleter     AdminUser?   @relation("task_charge_deleter", fields: [deleted_by], references: [id])
  restorer    AdminUser?   @relation("task_charge_restorer", fields: [restored_by], references: [id])
  task        Task         @relation(fields: [task_id], references: [id], onDelete: Cascade)
  updater     AdminUser    @relation("task_charge_updater", fields: [updated_by], references: [id])
  paid_via_invoice_id String? @db.Uuid
  paid_via_invoice    Invoice? @relation("InvoicePaidCharges", fields: [paid_via_invoice_id], references: [id], onDelete: SetNull)

  @@index([task_id, status, deleted_at])
  @@index([status])
  @@index([bearer])
  @@index([charge_type])
  @@index([amount])
  @@index([created_at])
}

model TaskCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  code        String   @unique
  description String?
  created_at  DateTime @default(now())
  created_by  String   @db.Uuid
  updated_at  DateTime @updatedAt
  updated_by  String   @db.Uuid
  tasks       Task[]
}

model TaskChecklistItem {
  id         String     @id @default(uuid()) @db.Uuid
  task_id    String     @db.Uuid
  title      String
  is_done    Boolean    @default(false)
  order      Int        @default(0)
  created_at DateTime   @default(now())
  updated_at DateTime   @updatedAt
  created_by String     @db.Uuid
  updated_by String     @db.Uuid
  deleted_at DateTime?
  deleted_by String?    @db.Uuid
  creator    AdminUser  @relation("task_checklist_creator", fields: [created_by], references: [id])
  deleter    AdminUser? @relation("task_checklist_deleter", fields: [deleted_by], references: [id])
  task       Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  updater    AdminUser  @relation("task_checklist_updater", fields: [updated_by], references: [id])

  @@index([task_id])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

model TaskAssignment {
  id                String    @id @default(uuid()) @db.Uuid
  task_id           String    @db.Uuid
  admin_user_id     String    @db.Uuid
  assigned_by       String    @db.Uuid
  assignment_source String?
  assigned_at       DateTime  @default(now())

  sla_days Int?
  due_date          DateTime?        
  sla_status        SLAStatus @default(RUNNING)
  sla_paused_at     DateTime?
  sla_breached_at   DateTime?
 

  assignee          AdminUser @relation("assignee", fields: [admin_user_id], references: [id])
  assigner          AdminUser @relation("assigner", fields: [assigned_by], references: [id])
  task              Task      @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@index([task_id])
  @@index([admin_user_id])
  @@index([admin_user_id, due_date])
  @@index([sla_status, sla_paused_at])
  @@index([sla_status, due_date])
}
model Task {
  id                      String              @id @default(uuid()) @db.Uuid
  entity_id               String?             @db.Uuid
  created_by              String              @db.Uuid
  title                   String
  description             String?
  status                  TaskStatus          @default(PENDING)
  start_date              DateTime?
  end_date                DateTime?
  due_date                DateTime?
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  last_activity_at        DateTime?
  last_activity_by        String?             @db.Uuid
  updated_by              String              @db.Uuid
  priority                TaskPriority        @default(NORMAL)
  is_billable             Boolean             @default(false)
  assigned_to_all         Boolean             @default(false)
  comment_count           Int                 @default(0)
  last_comment_at         DateTime?
  last_commented_by       String?             @db.Uuid
  task_category_id        String?             @db.Uuid
  invoice_internal_number String?             @db.VarChar(50)

  invoiced_at             DateTime?
  is_locked               Boolean             @default(false)
  is_system               Boolean             @default(false)
  task_type               TaskType            @default(REGULAR)
  creator                 AdminUser           @relation("task_creator", fields: [created_by], references: [id])
  entity                  Entity?             @relation(fields: [entity_id], references: [id])
  invoice                 Invoice?            @relation(fields: [invoice_internal_number], references: [internal_number])
  last_activity_admin     AdminUser?          @relation("last_activity_admin", fields: [last_activity_by], references: [id])
  category                TaskCategory?       @relation(fields: [task_category_id], references: [id])
  updater                 AdminUser           @relation("task_updater", fields: [updated_by], references: [id])
  assignments             TaskAssignment[]
  charges                 TaskCharge[]
  checklist_items         TaskChecklistItem[]

  @@index([entity_id, is_system, created_at])
  @@index([entity_id, task_type, created_at])
  @@index([entity_id, status, task_category_id, created_at])
  @@index([task_type, entity_id])
  @@index([invoice_internal_number])
  @@index([is_locked])
  @@index([status])
  @@index([entity_id])
  @@index([task_category_id])
  @@index([created_by])
  @@index([due_date])
  @@index([created_at])
}

model UserPushToken {
  id         String    @id @default(uuid())
  user_id    String    @db.Uuid
  token      String    @unique
  device     String?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  user       AdminUser @relation(fields: [user_id], references: [id])

  @@index([user_id])
}

model CompanyProfile {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @db.VarChar(150)
  legal_name      String?      @db.VarChar(200)
  pan             String?      @db.Char(10)
  gst_number      String?      @db.VarChar(15)
  email           String?
  phone           String?
  address_line1   String?      @db.VarChar(200)
  address_line2   String?      @db.VarChar(200)
  city            String?      @db.VarChar(50)
  state           IndianState?
  pincode         String?      @db.Char(6)
  bank_name       String?      @db.VarChar(100)
  bank_account_no String?      @db.VarChar(30)
  bank_ifsc       String?      @db.VarChar(15)
  bank_branch     String?      @db.VarChar(100)
  is_default      Boolean      @default(false)
  is_active       Boolean      @default(true)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  created_by      String       @db.Uuid
  updated_by      String       @db.Uuid
  invoices        Invoice[]

  @@index([name])
  @@index([gst_number])
  @@index([is_default])
}

model ReconcileStatsCurrent {
  entity_id                   String   @id @db.Uuid
  service_fee_total           Decimal  @db.Decimal(14, 2)
  service_fee_outstanding     Decimal  @db.Decimal(14, 2)
  service_fee_written_off     Decimal  @db.Decimal(14, 2)
  government_fee_total        Decimal  @db.Decimal(14, 2)
  government_fee_outstanding  Decimal  @db.Decimal(14, 2)
  government_fee_written_off  Decimal  @db.Decimal(14, 2)
  external_charge_total       Decimal  @db.Decimal(14, 2)
  external_charge_outstanding Decimal  @db.Decimal(14, 2)
  external_charge_written_off Decimal  @db.Decimal(14, 2)
  client_total_outstanding    Decimal  @db.Decimal(14, 2)
  pending_charges_count       Int
  updated_at                  DateTime @updatedAt
  entity                      Entity   @relation("ReconcileStats", fields: [entity_id], references: [id])

  @@map("reconcile_stats_current")
}

model EntityTaskStats {
  entity_id            String   @id @db.Uuid
  pending              Int      @default(0)
  in_progress          Int      @default(0)
  completed            Int      @default(0)
  cancelled            Int      @default(0)
  on_hold              Int      @default(0)
  pending_client_input Int      @default(0)
  total_tasks          Int      @default(0)
  updated_at           DateTime @updatedAt

  @@map("entity_task_stats")
}

model Invoice {
  id                 String          @id @default(uuid()) @db.Uuid
  entity_id          String          @db.Uuid
  company_profile_id String?         @db.Uuid
  internal_number    String          @unique
  external_number    String?
  status             InvoiceStatus   @default(DRAFT)
  invoice_date       DateTime?
  issued_at          DateTime?
  paid_at            DateTime?
  notes              String?
  created_by         String          @db.Uuid
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt
  company_profile    CompanyProfile? @relation(fields: [company_profile_id], references: [id])
  creator            AdminUser       @relation(fields: [created_by], references: [id])
  entity             Entity          @relation(fields: [entity_id], references: [id])
  tasks              Task[]
  paid_charges TaskCharge[] @relation("InvoicePaidCharges")
  @@index([entity_id, created_at, status])
  @@index([entity_id, invoice_date])
  @@index([entity_id, status])
  @@index([status])
  @@index([external_number])
  @@index([invoice_date])
  @@index([created_at])
}

model Document {
  id            String        @id @default(uuid()) @db.Uuid
  object_key    String        @unique
  bucket        String
  url           String
  original_name String
  mime_type     String
  size_bytes    Int
  scope         DocumentScope
  scope_id      String
  created_by    String        @db.Uuid
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  deleted_at    DateTime?
  creator       AdminUser     @relation("document_creator", fields: [created_by], references: [id])

  @@index([scope, scope_id])
  @@index([created_at])
}

enum AdminUserAppRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  VIEW_ONLY
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum DocumentScope {
  TASK
  INVOICE
  ENTITY
  COMPANY_PROFILE
  OTHER
}

enum AdminUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SLAStatus {
  NONE
  RUNNING
  PAUSED
  BREACHED
  COMPLETED
}

enum ChargeType {
  EXTERNAL_CHARGE
  GOVERNMENT_FEE
  SERVICE_FEE
  OTHER_CHARGES
}

enum ChargeBearer {
  CLIENT
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

enum ChargeStatus {
  NOT_PAID
  PAID
  WRITTEN_OFF
  CANCELLED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  PENDING_CLIENT_INPUT
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
}

enum TaskType {
  REGULAR
  SYSTEM_ADHOC
}

enum IndianState {
  ANDHRA_PRADESH
  ARUNACHAL_PRADESH
  ASSAM
  BIHAR
  CHHATTISGARH
  GOA
  GUJARAT
  HARYANA
  HIMACHAL_PRADESH
  JHARKHAND
  KARNATAKA
  KERALA
  MADHYA_PRADESH
  MAHARASHTRA
  MANIPUR
  MEGHALAYA
  MIZORAM
  NAGALAND
  ODISHA
  PUNJAB
  RAJASTHAN
  SIKKIM
  TAMIL_NADU
  TELANGANA
  TRIPURA
  UTTAR_PRADESH
  UTTARAKHAND
  WEST_BENGAL
  ANDAMAN_AND_NICOBAR_ISLANDS
  CHANDIGARH
  DADRA_AND_NAGAR_HAVELI_AND_DAMAN_AND_DIU
  DELHI
  JAMMU_AND_KASHMIR
  LADAKH
  LAKSHADWEEP
  PUDUCHERRY
}

enum EntityType {
  INDIVIDUAL
  UN_REGISTRED
  PRIVATE_LIMITED_COMPANY
  PUBLIC_LIMITED_COMPANY
  ONE_PERSON_COMPANY
  SECTION_8_COMPANY
  PRODUCER_COMPANY
  SOLE_PROPRIETORSHIP
  PARTNERSHIP_FIRM
  LIMITED_LIABILITY_PARTNERSHIP
  TRUST
  SOCIETY
  COOPERATIVE_SOCIETY
  FOREIGN_COMPANY
  GOVERNMENT_COMPANY
  ASSOCIATION_OF_PERSON
  HUF
}


