generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminUserAppRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  EMPLOYEE
  VIEW_ONLY
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AdminUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ChargeType {
  EXTERNAL_CHARGE
  GOVERNMENT_FEE
  SERVICE_FEE
}

enum ChargeBearer {
  CLIENT
  FIRM
}

enum ChargeStatus {
  NOT_PAID
  PAID
  WRITTEN_OFF
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  PENDING_CLIENT_INPUT
}

enum TaskPriority {
  LOW
  NORMAL
  HIGH
}

enum PracticeFirm {
  DLAA_CA_FIRM
  AFIN_ADVISORY_PVT_LTD
  MUTUAL_FUND_ADVISORY
}

enum IndianState {
  ANDHRA_PRADESH
  ARUNACHAL_PRADESH
  ASSAM
  BIHAR
  CHHATTISGARH
  GOA
  GUJARAT
  HARYANA
  HIMACHAL_PRADESH
  JHARKHAND
  KARNATAKA
  KERALA
  MADHYA_PRADESH
  MAHARASHTRA
  MANIPUR
  MEGHALAYA
  MIZORAM
  NAGALAND
  ODISHA
  PUNJAB
  RAJASTHAN
  SIKKIM
  TAMIL_NADU
  TELANGANA
  TRIPURA
  UTTAR_PRADESH
  UTTARAKHAND
  WEST_BENGAL
  ANDAMAN_AND_NICOBAR_ISLANDS
  CHANDIGARH
  DADRA_AND_NAGAR_HAVELI_AND_DAMAN_AND_DIU
  DELHI
  JAMMU_AND_KASHMIR
  LADAKH
  LAKSHADWEEP
  PUDUCHERRY
}

enum EntityType {
  INDIVIDUAL
  UN_REGISTRED
  PRIVATE_LIMITED_COMPANY
  PUBLIC_LIMITED_COMPANY
  ONE_PERSON_COMPANY
  SECTION_8_COMPANY
  PRODUCER_COMPANY
  SOLE_PROPRIETORSHIP
  PARTNERSHIP_FIRM
  LIMITED_LIABILITY_PARTNERSHIP
  TRUST
  SOCIETY
  COOPERATIVE_SOCIETY
  FOREIGN_COMPANY
  GOVERNMENT_COMPANY
  ASSOCIATION_OF_PERSON
  HUF
}

model Entity {
  id              String       @id @default(uuid()) @db.Uuid
  entity_type     EntityType
  name            String       @db.VarChar(120)
  pan             String?      @unique
  email           String
  primary_phone   String
  contact_person  String?      @db.VarChar(100)
  secondary_phone String?
  address_line1   String?      @db.VarChar(200)
  address_line2   String?      @db.VarChar(200)
  city            String?      @db.VarChar(50)
  state           String?      @db.VarChar(50)
  pincode         String?      @db.Char(6)
  status          EntityStatus @default(INACTIVE)
  created_by      String       @db.Uuid
  updated_by      String?      @db.Uuid
  deleted_by      String?      @db.Uuid
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  deleted_at      DateTime?

  creator AdminUser  @relation("entity_creator", fields: [created_by], references: [id])
  updater AdminUser? @relation("entity_updater", fields: [updated_by], references: [id])
  deleter AdminUser? @relation("entity_deleter", fields: [deleted_by], references: [id])

  tasks Task[]

  @@index([name])
  @@index([pan])
  @@index([email])
  @@index([status])
  @@index([created_at])
  @@index([deleted_at])
  @@index([status, created_at])
}

model AdminUser {
  id                                    String           @id @default(uuid()) @db.Uuid
  name                                  String
  email                                 String           @unique
  password                              String?
  user_code                             String           @unique
  status                                AdminUserStatus  @default(INACTIVE)
  date_of_joining                       DateTime         @default(now())
  onboarding_completed                  Boolean          @default(false)
  admin_role                            AdminUserAppRole @default(EMPLOYEE)
  phone                                 String           @unique
  alternate_phone                       String?
  last_invite_sent_at                   DateTime?
  address_line1                         String?          @db.VarChar(200)
  address_line2                         String?          @db.VarChar(200)
  city                                  String?          @db.VarChar(50)
  state                                 IndianState?
  pincode                               String?          @db.Char(6)
  totp_secret                           String?
  last_login_at                         DateTime?
  password_set_at                       DateTime?
  is_2fa_enabled                        Boolean          @default(false)
  onboarding_token_expires_at           DateTime?
  last_password_reset_request_at        DateTime?
  onboarding_token_hash                 String?
  password_reset_token_hash             String?
  password_reset_token_expires_at       DateTime?
  last_onboarding_reset_request_at      DateTime?
  onboarding_reset_token_hash           String?
  onboarding_reset_token_expires_at     DateTime?
  two_fa_verified_at                    DateTime?
  auth_provider                         String           @default("credentials")
  provider_id                           String?
  created_by                            String?          @db.Uuid
  updated_by                            String?          @db.Uuid
  deleted_by                            String?          @db.Uuid
  deleted_at                            DateTime?

  creator AdminUser? @relation("admin_creator", fields: [created_by], references: [id])
  updater AdminUser? @relation("admin_updater", fields: [updated_by], references: [id])
  deleter AdminUser? @relation("admin_deleter", fields: [deleted_by], references: [id])

  created_task_checklist_items TaskChecklistItem[] @relation("task_checklist_creator")
  updated_task_checklist_items TaskChecklistItem[] @relation("task_checklist_updater")
  deleted_task_checklist_items TaskChecklistItem[] @relation("task_checklist_deleter")

  created_admins   AdminUser[] @relation("admin_creator")
  updated_admins   AdminUser[] @relation("admin_updater")
  deleted_admins   AdminUser[] @relation("admin_deleter")
  created_entities Entity[]    @relation("entity_creator")
  updated_entities Entity[]    @relation("entity_updater")
  deleted_entities Entity[]    @relation("entity_deleter")

  created_tasks        Task[]             @relation("task_creator")
  task_assignments     TaskAssignment[]   @relation("assignee")
  assigned_tasks       TaskAssignment[]   @relation("assigner")
  last_activity_tasks  Task[]             @relation("last_activity_admin")
  updated_tasks        Task[]             @relation("task_updater")
  permissions          AdminUserPermission[]
  pushTokens           UserPushToken[]
  created_task_charges TaskCharge[]       @relation("task_charge_creator")
  updated_task_charges TaskCharge[]       @relation("task_charge_updater")
  deleted_task_charges TaskCharge[]       @relation("task_charge_deleter")

  @@index([email])
  @@index([name])
  @@index([user_code])
  @@index([phone])
  @@index([status])
}

model AdminUserPermission {
  admin_user_id String @db.Uuid
  permission_id String @db.Uuid

  adminUser  AdminUser  @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  assigned_at DateTime @default(now())

  @@id([admin_user_id, permission_id])
  @@index([admin_user_id])
  @@index([permission_id])
}

model Permission {
  id       String  @id @default(uuid()) @db.Uuid
  code     String  @unique
  label    String?
  category String?

  adminUserPermissions AdminUserPermission[]
}

model AdminUserCounter {
  id            String   @id
  current_count Int      @default(0)
  updated_at    DateTime @updatedAt

  @@map("admin_user_counter")
}

model TaskCharge {
  id          String       @id @default(uuid()) @db.Uuid
  task_id     String       @db.Uuid
  title       String
  amount      Decimal      @db.Decimal(12, 2)
  charge_type ChargeType
  bearer      ChargeBearer
  status      ChargeStatus
  remark      String?
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  deleted_at  DateTime?
  created_by  String       @db.Uuid
  updated_by  String       @db.Uuid
  deleted_by  String?      @db.Uuid

  task    Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  creator AdminUser  @relation("task_charge_creator", fields: [created_by], references: [id])
  updater AdminUser  @relation("task_charge_updater", fields: [updated_by], references: [id])
  deleter AdminUser? @relation("task_charge_deleter", fields: [deleted_by], references: [id])

  @@index([task_id])
  @@index([deleted_at])
}

model TaskCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  code        String   @unique
  description String?
  created_at  DateTime @default(now())
  created_by  String   @db.Uuid
  updated_at  DateTime @updatedAt
  updated_by  String   @db.Uuid

  tasks Task[]
}

model TaskChecklistItem {
  id         String   @id @default(uuid()) @db.Uuid
  task_id    String   @db.Uuid
  title      String
  is_done    Boolean  @default(false)
  order      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?
  created_by String   @db.Uuid
  updated_by String   @db.Uuid
  deleted_by String?  @db.Uuid

  task    Task       @relation(fields: [task_id], references: [id], onDelete: Cascade)
  creator AdminUser  @relation("task_checklist_creator", fields: [created_by], references: [id])
  updater AdminUser  @relation("task_checklist_updater", fields: [updated_by], references: [id])
  deleter AdminUser? @relation("task_checklist_deleter", fields: [deleted_by], references: [id])

  @@index([task_id])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

model TaskAssignment {
  id                String   @id @default(uuid()) @db.Uuid
  task_id           String   @db.Uuid
  admin_user_id     String   @db.Uuid
  assigned_by       String   @db.Uuid
  assignment_source String?
  assigned_at       DateTime @default(now())

  task     Task      @relation(fields: [task_id], references: [id], onDelete: Cascade)
  assignee AdminUser @relation("assignee", fields: [admin_user_id], references: [id])
  assigner AdminUser @relation("assigner", fields: [assigned_by], references: [id])

  @@index([task_id])
  @@index([admin_user_id])
  @@index([assigned_by])
  @@index([assigned_at])
  @@index([admin_user_id, task_id])
}

model Task {
  id                String        @id @default(uuid()) @db.Uuid
  entity_id         String?       @db.Uuid
  task_category_id  String?       @db.Uuid
  title             String
  description       String?
  status            TaskStatus    @default(PENDING)
  priority          TaskPriority  @default(NORMAL)
  start_date        DateTime?
  end_date          DateTime?
  due_date          DateTime?
  is_billable       Boolean       @default(false)
  invoice_number    String?
  billed_from_firm  PracticeFirm?
  assigned_to_all   Boolean       @default(false)
  last_activity_at  DateTime?
  last_activity_by  String?       @db.Uuid
  created_at        DateTime      @default(now())
  created_by        String        @db.Uuid
  updated_at        DateTime      @updatedAt
  updated_by        String        @db.Uuid
  last_comment_at   DateTime?
  last_commented_by String?       @db.Uuid
  comment_count     Int           @default(0)

  entity              Entity?             @relation(fields: [entity_id], references: [id], onDelete: SetNull)
  category            TaskCategory?       @relation(fields: [task_category_id], references: [id], onDelete: SetNull)
  creator             AdminUser           @relation("task_creator", fields: [created_by], references: [id])
  updater             AdminUser           @relation("task_updater", fields: [updated_by], references: [id])
  last_activity_admin AdminUser?          @relation("last_activity_admin", fields: [last_activity_by], references: [id])
  assignments         TaskAssignment[]
  charges             TaskCharge[]
  checklist_items     TaskChecklistItem[]

  @@index([status])
  @@index([entity_id])
  @@index([task_category_id])
  @@index([created_by])
  @@index([due_date])
  @@index([created_at])
}

model UserPushToken {
  id         String   @id @default(uuid())
  user_id    String   @db.Uuid
  token      String   @unique
  device     String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user AdminUser @relation(fields: [user_id], references: [id])

  @@index([user_id])
}